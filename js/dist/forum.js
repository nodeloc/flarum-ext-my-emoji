(()=>{var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var i in o)t.o(o,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:o[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";function o(t,e){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},o(t,e)}function i(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,o(t,e)}t.r(e);const n=flarum.core.compat["common/extend"],r=flarum.core.compat["common/app"];var a=t.n(r);const s=flarum.core.compat["common/components/Button"];var c=t.n(s);const l=flarum.core.compat["common/components/Tooltip"];var u=t.n(l),d=function(t){function e(){return t.apply(this,arguments)||this}return i(e,t),e.prototype.view=function(e){var o=t.prototype.view.call(this,e),i=this.attrs.tooltipText||o.attrs.title;return delete o.attrs.title,m(u(),{text:i,position:"top",showOnFocus:!1},o)},e.initAttrs=function(e){t.initAttrs.call(this,e),e.className="Button Button--icon Button--link Button-MyEmoji "+(e.active?"active":""),e.tooltipText=e.title},e}(c());const h=flarum.core.compat["common/components/TextEditor"];var p=t.n(h);const y=flarum.core.compat["common/Component"];var f=t.n(y);const g=flarum.core.compat["common/components/LoadingIndicator"];var v=t.n(g),j={data:null,categories:[],loading:!1,lastLoadTime:0,expirationTime:12e5,isValid:function(){return this.data&&Date.now()-this.lastLoadTime<this.expirationTime},reset:function(){this.data=null,this.categories=[],this.loading=!1,this.lastLoadTime=0},setData:function(t,e){this.data=t,this.categories=e,this.lastLoadTime=Date.now(),this.loading=!1}},b=function(t){function e(){return t.apply(this,arguments)||this}i(e,t);var o=e.prototype;return o.oninit=function(e){t.prototype.oninit.call(this,e),this.loading=!j.isValid(),this.emojiData=j.data||{},this.categories=j.categories||[],this.currentCategory=this.categories.length>0?this.categories[0].id:null,this.itemsPerPage=30,this.currentPage=1,this.hasMoreItems=!0,j.isValid()||j.loading||this.loadEmojiData()},o.oncreate=function(e){var o=this;t.prototype.oncreate.call(this,e),this.boundHandleOutsideClick=this.handleOutsideClick.bind(this),document.addEventListener("mousedown",this.boundHandleOutsideClick),this.boundHandleKeyDown=this.handleKeyDown.bind(this),document.addEventListener("keydown",this.boundHandleKeyDown),setTimeout((function(){o.element&&(o.element.style.display="none",o.element.offsetHeight,o.element.style.display="",o.emojiListElement&&!o.intersectionObserver&&o.setupIntersectionObserver())}),10)},o.onremove=function(e){t.prototype.onremove.call(this,e),document.removeEventListener("mousedown",this.boundHandleOutsideClick),document.removeEventListener("keydown",this.boundHandleKeyDown),this.intersectionObserver&&this.intersectionObserver.disconnect()},o.handleOutsideClick=function(t){var e;!this.element||this.element.contains(t.target)||null!=(e=document.querySelector(".Button-MyEmoji"))&&e.contains(t.target)||this.attrs.onClose()},o.handleKeyDown=function(t){"Escape"===t.key&&this.attrs.onClose()},o.loadEmojiData=function(){var t=this;j.loading=!0,a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/nodeloc/myemoji"}).then((function(e){var o=a().forum.attribute("baseUrl"),i=[];e.data.forEach((function(t){var e,n=t.attributes.path;i.push({id:t.id,name:t.attributes.title,textToReplace:t.attributes.text_to_replace,emoji:(e=n,e&&/^(https?:)?\/\//i.test(e)?n:o+n),category:t.attributes.category,category_name:t.attributes.category_name,loaded:!1})}));var n=i.reduce((function(t,e){return(t[e.category]=t[e.category]||[]).push(e),t}),{}),r=Object.keys(n).map((function(t){return{id:t,name:n[t][0].category_name}}));j.setData(n,r),t.emojiData=n,t.categories=r,t.loading=!1,r.length>0&&t.selectCategory(r[0].id),m.redraw()})).catch((function(e){console.error("Error loading emoji data:",e),t.loading=!1,j.loading=!1,m.redraw()}))},o.selectCategory=function(t){this.currentCategory=t,this.currentPage=1,this.hasMoreItems=!0,this.emojiListElement&&(this.emojiListElement.scrollTop=0),m.redraw()},o.getCurrentEmojis=function(){return this.currentCategory&&this.emojiData[this.currentCategory]?this.emojiData[this.currentCategory].slice(0,this.currentPage*this.itemsPerPage):[]},o.handleScroll=function(t){var e=t.target;e.scrollHeight-e.scrollTop-e.clientHeight<50&&this.loadMoreItems()},o.loadMoreItems=function(){if(this.hasMoreItems&&this.currentCategory&&this.emojiData[this.currentCategory]){var t=this.emojiData[this.currentCategory].length;this.currentPage*this.itemsPerPage<t?(this.currentPage++,m.redraw()):this.hasMoreItems=!1}},o.handleEmojiSelect=function(t){this.attrs.insertEmoji(t.textToReplace),this.attrs.onClose()},o.setupIntersectionObserver=function(){var t=this;"IntersectionObserver"in window&&(this.intersectionObserver=new IntersectionObserver((function(e,o){e.forEach((function(e){if(e.isIntersecting){var i=e.target.dataset.emojiId,n=e.target.dataset.categoryId;if(t.emojiData[n]){var r=t.emojiData[n].find((function(t){return t.id===i}));r&&(r.loaded=!0,m.redraw())}o.unobserve(e.target)}}))}),{root:this.emojiListElement,rootMargin:"100px",threshold:.1}))},o.view=function(){var t=this;return m("div",{className:"MyEmoji-picker",onclick:function(t){return t.stopPropagation()},oncreate:function(e){t.element=e.dom}},[m("div",{className:"MyEmoji-tab-bar"},this.categories.map((function(e){return m("button",{className:t.currentCategory===e.id?"active":"",onclick:function(){return t.selectCategory(e.id)}},e.name)}))),m("div",{className:"emoji-picker",oncreate:function(e){t.emojiListElement=e.dom,t.setupIntersectionObserver()},onscroll:function(e){return t.handleScroll(e)}},this.loading?m("div",{className:"MyEmoji-loading"},m(v())):m("div",{className:"MyEmoji-grid"},[].concat(this.getCurrentEmojis().map((function(e){return m("span",{className:"MyEmoji",onclick:function(){return t.handleEmojiSelect(e)},title:e.name},e.loaded?m("img",{src:e.emoji,alt:e.name}):m("div",{className:"emoji-lazyload","data-emoji-id":e.id,"data-category-id":e.category,oncreate:function(o){t.intersectionObserver?t.intersectionObserver.observe(o.dom):e.loaded=!0}},m(v(),{size:"small"})))})),[this.hasMoreItems&&this.getCurrentEmojis().length>0?m("div",{className:"MyEmoji-load-more"},m(v(),{size:"small"})):null])))])},e}(f());a().initializers.add("nodeloc-flarum-ext-my-emoji",(function(){(0,n.extend)(p().prototype,"oninit",(function(){this.isMyEmojiPickerVisible=!1,this.myEmojiPosition={top:0,left:0}})),(0,n.extend)(p().prototype,"toolbarItems",(function(t){var e=this;t.remove("emoji"),t.add("MyEmoji",d.component({onclick:function(t){t.preventDefault(),e.isMyEmojiPickerVisible=!e.isMyEmojiPickerVisible,e.isMyEmojiPickerVisible&&e.calculateMyEmojiPosition(t),m.redraw()},icon:"far fa-smile-wink",title:a().translator.trans("nodeloc-emoji.forum.composer.emoji_tooltip")}))})),(0,n.extend)(p().prototype,"oncreate",(function(){var t=this;this.boundRepositionMyEmoji=function(){t.isMyEmojiPickerVisible&&(t.calculateMyEmojiPosition(),m.redraw())},window.addEventListener("resize",this.boundRepositionMyEmoji)})),(0,n.extend)(p().prototype,"onremove",(function(){window.removeEventListener("resize",this.boundRepositionMyEmoji)})),(0,n.extend)(p().prototype,"calculateMyEmojiPosition",(function(t){var e=document.querySelector(".Button-MyEmoji");if(e){var o=e.getBoundingClientRect();if(window.innerWidth<=768)this.myEmojiPosition={position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"90%",maxWidth:"90vw",height:"auto",maxHeight:"80vh"};else{var i=o.left+o.width/2-260,n=Math.max(10,i),r=Math.min(320,o.top-10),a=r>=200;this.myEmojiPosition={position:"fixed",bottom:window.innerHeight-o.top+10+"px",left:n+"px",width:"520px",height:a?"320px":"auto",minHeight:"140px",maxHeight:r+"px"}}}})),(0,n.extend)(p().prototype,"view",(function(t){var e=this;return this.isMyEmojiPickerVisible&&t.children.push(m("div",{className:"ComposerBody-MyEmojiContainer",style:this.myEmojiPosition},m(b,{insertEmoji:function(t){e.attrs.composer.editor.insertAtCursor(t)},onClose:function(){e.isMyEmojiPickerVisible=!1,m.redraw()}}))),t}))}),-150)})(),module.exports=e})();
//# sourceMappingURL=forum.js.map