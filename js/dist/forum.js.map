{"version":3,"file":"forum.js","mappings":"MACA,IAAIA,EAAsB,CCA1BA,EAAyBC,IACxB,IAAIC,EAASD,GAAUA,EAAOE,WAC7B,IAAOF,EAAiB,QACxB,IAAM,EAEP,OADAD,EAAoBI,EAAEF,EAAQ,CAAEG,EAAGH,IAC5BA,CAAM,ECLdF,EAAwB,CAACM,EAASC,KACjC,IAAI,IAAIC,KAAOD,EACXP,EAAoBS,EAAEF,EAAYC,KAASR,EAAoBS,EAAEH,EAASE,IAC5EE,OAAOC,eAAeL,EAASE,EAAK,CAAEI,YAAY,EAAMC,IAAKN,EAAWC,IAE1E,ECNDR,EAAwB,CAACc,EAAKC,IAAUL,OAAOM,UAAUC,eAAeC,KAAKJ,EAAKC,GCClFf,EAAyBM,IACH,oBAAXa,QAA0BA,OAAOC,aAC1CV,OAAOC,eAAeL,EAASa,OAAOC,YAAa,CAAEC,MAAO,WAE7DX,OAAOC,eAAeL,EAAS,aAAc,CAAEe,OAAO,GAAO,G,wBCL/C,SAASC,EAAgBb,EAAGc,GAKzC,OAJAD,EAAkBZ,OAAOc,eAAiBd,OAAOc,eAAeC,OAAS,SAAyBhB,EAAGc,GAEnG,OADAd,EAAEiB,UAAYH,EACPd,CACT,EACOa,EAAgBb,EAAGc,EAC5B,CCLe,SAASI,EAAeC,EAAUC,GAC/CD,EAASZ,UAAYN,OAAOoB,OAAOD,EAAWb,WAC9CY,EAASZ,UAAUe,YAAcH,EACjCJ,EAAeI,EAAUC,EAC3B,C,OCLA,MAAM,EAA+BG,OAAOC,KAAKC,OAAO,iBCAlD,EAA+BF,OAAOC,KAAKC,OAAO,c,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,4B,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,6B,aCOnCC,EAAgB,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAC,MAAA,KAAAC,YAAA,KAoBlC,OApBkCX,EAAAQ,EAAAC,GAAAD,EAAAnB,UACnCuB,KAAA,SAAKC,GACH,IAAMC,EAAYL,EAAApB,UAASuB,KAAIrB,KAAC,KAAAsB,GAG1BE,EAAcC,KAAKC,MAAMF,aAAeD,EAAaG,MAAMC,MAGjE,cAFOJ,EAAaG,MAAMC,MAGxBC,EAACC,IAAO,CAACC,KAAMN,EAAaO,SAAS,MAAMC,aAAa,GACrDT,EAGP,EAACN,EAEMgB,UAAP,SAAiBP,GACfR,EAAMe,UAASjC,KAAC,KAAA0B,GAEhBA,EAAMQ,UAAY,oDAAmDR,EAAMS,OAAS,SAAW,IAC/FT,EAAMF,YAAcE,EAAMC,KAC5B,EAACV,CAAA,CApBkC,CAASmB,KCP9C,MAAM,EAA+BtB,OAAOC,KAAKC,OAAO,gC,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,oB,aCAxD,MAAM,EAA+BF,OAAOC,KAAKC,OAAO,sC,aCSlDqB,EAAmB,CACvBC,KAAM,KACNC,WAAY,GACZC,SAAS,EACTC,aAAc,EAEdC,eAAgB,KAEhBC,QAAO,WACL,OAAOlB,KAAKa,MAAQM,KAAKC,MAAQpB,KAAKgB,aAAehB,KAAKiB,cAC5D,EAEAI,MAAK,WACHrB,KAAKa,KAAO,KACZb,KAAKc,WAAa,GAClBd,KAAKe,SAAU,EACff,KAAKgB,aAAe,CACtB,EAEAM,QAAO,SAACT,EAAMC,GACZd,KAAKa,KAAOA,EACZb,KAAKc,WAAaA,EAClBd,KAAKgB,aAAeG,KAAKC,MACzBpB,KAAKe,SAAU,CACjB,GAOIQ,EAAa,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAA9B,MAAA,KAAAC,YAAA,KAAAX,EAAAuC,EAAAC,GAAA,IAAAC,EAAAF,EAAAlD,UAwQhB,OAxQgBoD,EACjBC,OAAA,SAAO7B,GACL2B,EAAAnD,UAAMqD,OAAMnD,KAAC,KAAAsB,GAEbG,KAAKe,SAAWH,EAAiBM,UACjClB,KAAK2B,UAAYf,EAAiBC,MAAQ,CAAC,EAC3Cb,KAAKc,WAAaF,EAAiBE,YAAc,GACjDd,KAAK4B,gBAAkB5B,KAAKc,WAAWe,OAAS,EAAI7B,KAAKc,WAAW,GAAGgB,GAAK,KAG5E9B,KAAK+B,aAAe,GACpB/B,KAAKgC,YAAc,EACnBhC,KAAKiC,cAAe,EAGfrB,EAAiBM,WAAcN,EAAiBG,SACnDf,KAAKkC,eAET,EAACT,EAEDU,SAAA,SAAStC,GACP2B,EAAAnD,UAAM8D,SAAQ5D,KAAC,KAAAsB,GAGfG,KAAKoC,wBAA0BpC,KAAKqC,mBAAmBvD,KAAKkB,MAC5DsC,SAASC,iBAAiB,YAAavC,KAAKoC,yBAG5CpC,KAAKwC,mBAAqBxC,KAAKyC,cAAc3D,KAAKkB,MAClDsC,SAASC,iBAAiB,UAAWvC,KAAKwC,mBAC5C,EAACf,EAEDiB,SAAA,SAAS7C,GACP2B,EAAAnD,UAAMqE,SAAQnE,KAAC,KAAAsB,GAGfyC,SAASK,oBAAoB,YAAa3C,KAAKoC,yBAC/CE,SAASK,oBAAoB,UAAW3C,KAAKwC,oBAGzCxC,KAAK4C,sBACP5C,KAAK4C,qBAAqBC,YAE9B,EAACpB,EAEDY,mBAAA,SAAmBS,GAAG,IAAAC,GAEhB/C,KAAKgD,SAAYhD,KAAKgD,QAAQC,SAASH,EAAEI,SACC,OAA1CH,EAACT,SAASa,cAAc,qBAAvBJ,EAA2CE,SAASH,EAAEI,SACzDlD,KAAKC,MAAMmD,SAEf,EAAC3B,EAEDgB,cAAA,SAAcK,GACE,WAAVA,EAAEjF,KACJmC,KAAKC,MAAMmD,SAEf,EAAC3B,EAEDS,cAAA,WAAgB,IAAAmB,EAAA,KAEdzC,EAAiBG,SAAU,EAE3BuC,IAAAA,QACW,CACPC,OAAQ,MACRC,IAAKF,IAAAA,MAAUG,UAAU,UAAY,qBAEtCC,MAAK,SAACC,GACL,IAAMC,EAAUN,IAAAA,MAAUG,UAAU,WAC9BI,EAAe,GAErBF,EAAe,KAAEG,SAAQ,SAACC,GACxB,IChHyBP,EDgHnBQ,EAAOD,EAAwB,WAAQ,KAE7CF,EAAaI,KAAK,CAChBnC,GAAIiC,EAAgB,GACpBG,KAAMH,EAAwB,WAAS,MACvCI,cAAeJ,EAAwB,WAAmB,gBAC1DK,OCtHuBZ,EDsHLQ,ECrHvBR,GAGE,mBAAmBa,KAAKb,GDkHKQ,EAAOJ,EAAUI,GAC3CM,SAAUP,EAAwB,WAAY,SAC9CQ,cAAeR,EAAwB,WAAiB,cAExDS,QAAQ,GAEZ,IAGA,IAAM7C,EAAYkC,EAAaY,QAAO,SAACC,EAAQN,GAE7C,OADCM,EAAON,EAAME,UAAYI,EAAON,EAAME,WAAa,IAAIL,KAAKG,GACtDM,CACT,GAAG,CAAC,GAGE5D,EAAa/C,OAAO4G,KAAKhD,GAAWiD,KAAI,SAAAC,GAC5C,MAAO,CACL/C,GAAI+C,EACJX,KAAMvC,EAAUkD,GAAY,GAAGN,cAEnC,IAGA3D,EAAiBU,QAAQK,EAAWb,GAGpCuC,EAAK1B,UAAYA,EACjB0B,EAAKvC,WAAaA,EAClBuC,EAAKtC,SAAU,EAGXD,EAAWe,OAAS,GACtBwB,EAAKyB,eAAehE,EAAW,GAAGgB,IAGpC3B,EAAE4E,QACJ,IAAE,OACK,SAAAC,GACLC,QAAQD,MAAM,4BAA6BA,GAC3C3B,EAAKtC,SAAU,EACfH,EAAiBG,SAAU,EAC3BZ,EAAE4E,QACJ,GACJ,EAACtD,EAEDqD,eAAA,SAAeD,GACb7E,KAAK4B,gBAAkBiD,EACvB7E,KAAKgC,YAAc,EACnBhC,KAAKiC,cAAe,EAGhBjC,KAAKkF,mBACPlF,KAAKkF,iBAAiBC,UAAY,GAGpChF,EAAE4E,QACJ,EAACtD,EAED2D,iBAAA,WACE,OAAKpF,KAAK4B,iBACL5B,KAAK2B,UAAU3B,KAAK4B,iBAElB5B,KAAK2B,UAAU3B,KAAK4B,iBAAiByD,MAAM,EAAGrF,KAAKgC,YAAchC,KAAK+B,cAH3C,EAIpC,EAACN,EAED6D,aAAA,SAAaxC,GACX,IAAMyC,EAAKzC,EAAEI,OAGTqC,EAAGC,aAAeD,EAAGJ,UAAYI,EAAGE,aAAe,IACrDzF,KAAK0F,eAET,EAACjE,EAEDiE,cAAA,WACE,GAAK1F,KAAKiC,cAAiBjC,KAAK4B,iBAAoB5B,KAAK2B,UAAU3B,KAAK4B,iBAAxE,CAEA,IAAM+D,EAAa3F,KAAK2B,UAAU3B,KAAK4B,iBAAiBC,OAEpD7B,KAAKgC,YAAchC,KAAK+B,aAAe4D,GACzC3F,KAAKgC,cACL7B,EAAE4E,UAEF/E,KAAKiC,cAAe,CAR0E,CAUlG,EAACR,EAEDmE,kBAAA,SAAkBxB,GAEhBpE,KAAKC,MAAM4F,YAAYzB,EAAMD,eAG7BnE,KAAKC,MAAMmD,SACb,EAAC3B,EAEDqE,0BAAA,WAA4B,IAAAC,EAAA,KACpB,yBAA0BC,SAEhChG,KAAK4C,qBAAuB,IAAIqD,sBAC9B,SAACC,EAASC,GACRD,EAAQpC,SAAQ,SAAAsC,GACd,GAAIA,EAAMC,eAAgB,CACxB,IAAMC,EAAUF,EAAMlD,OAAOqD,QAAQD,QAC/BzB,EAAauB,EAAMlD,OAAOqD,QAAQ1B,WAGxC,GAAIkB,EAAKpE,UAAUkD,GAAa,CAC9B,IAAMT,EAAQ2B,EAAKpE,UAAUkD,GAAY2B,MAAK,SAAA1D,GAAC,OAAIA,EAAEhB,KAAOwE,CAAO,IAC/DlC,IACFA,EAAMI,QAAS,EACfrE,EAAE4E,SAEN,CAGAoB,EAASM,UAAUL,EAAMlD,OAC3B,CACF,GACF,GACA,CACEwD,KAAM1G,KAAKkF,iBACXyB,WAAY,QACZC,UAAW,KAGjB,EAACnF,EAED7B,KAAA,WAAO,IAAAiH,EAAA,KACL,OAAO1G,EAAE,MAAO,CACdM,UAAW,iBACXqG,QAAS,SAAChE,GAAC,OAAKA,EAAEiE,iBAAiB,GAClC,CAED5G,EAAE,MAAO,CAAEM,UAAW,mBACpBT,KAAKc,WAAW8D,KAAI,SAAAN,GAAQ,OAC1BnE,EAAE,SAAU,CACVM,UAAWoG,EAAKjF,kBAAoB0C,EAASxC,GAAK,SAAW,GAC7DgF,QAAS,kBAAMD,EAAK/B,eAAeR,EAASxC,GAAG,GAC9CwC,EAASJ,KAAK,KAKrB/D,EAAE,MAAO,CACPM,UAAW,eACX0B,SAAU,SAACtC,GACTgH,EAAK3B,iBAAmBrF,EAAMmH,IAC9BH,EAAKf,2BACP,EACAmB,SAAU,SAACnE,GAAC,OAAK+D,EAAKvB,aAAaxC,EAAE,GAErC9C,KAAKe,QACHZ,EAAE,MAAO,CAAEM,UAAW,mBAAqBN,EAAE+G,MAC7C/G,EAAE,MAAO,CAAEM,UAAW,gBAAkB,GAAF0G,OAEjCnH,KAAKoF,mBAAmBR,KAAI,SAAAR,GAAK,OAClCjE,EAAE,OAAQ,CACRM,UAAW,UACXqG,QAAS,kBAAMD,EAAKjB,kBAAkBxB,EAAM,EAC5ClE,MAAOkE,EAAMF,MAEbE,EAAMI,OACJrE,EAAE,MAAO,CAAEiH,IAAKhD,EAAMA,MAAOiD,IAAKjD,EAAMF,OACxC/D,EAAE,MAAO,CACPM,UAAW,iBACX,gBAAiB2D,EAAMtC,GACvB,mBAAoBsC,EAAME,SAC1BnC,SAAU,SAACtC,GACLgH,EAAKjE,qBACPiE,EAAKjE,qBAAqB0E,QAAQzH,EAAMmH,KAExC5C,EAAMI,QAAS,CAEnB,GACCrE,EAAE+G,IAAkB,CAAEK,KAAM,WAClC,IACF,CAGDvH,KAAKiC,cAAgBjC,KAAKoF,mBAAmBvD,OAAS,EACpD1B,EAAE,MAAO,CAAEM,UAAW,qBAAuBN,EAAE+G,IAAkB,CAAEK,KAAM,WACzE,UAIZ,EAAChG,CAAA,CAxQgB,CAASiG,KA2Q5BlE,IAAAA,aAAiBmE,IACf,+BACA,YACEC,EAAAA,EAAAA,QAAOC,IAAAA,UAAsB,UAAU,WACrC3H,KAAK4H,wBAAyB,EAC9B5H,KAAK6H,gBAAkB,CAAEC,IAAK,EAAGC,KAAM,EACzC,KAEAL,EAAAA,EAAAA,QAAOC,IAAAA,UAAsB,gBAAgB,SAAUK,GAAO,IAAAC,EAAA,KAC5DD,EAAME,OAAO,SACbF,EAAMP,IACJ,UACAjI,EAAiB2I,UAAU,CACzBrB,QAAS,SAACsB,GACRA,EAAMC,iBAGNJ,EAAKL,wBAA0BK,EAAKL,uBAEhCK,EAAKL,wBACPK,EAAKK,yBAAyBF,GAGhCjI,EAAE4E,QACJ,EACAwD,KAAM,oBACNrI,MAAOoD,IAAAA,WAAekF,MAAM,gDAGlC,KAEAd,EAAAA,EAAAA,QAAOC,IAAAA,UAAsB,YAAY,WAAY,IAAAc,EAAA,KAEnDzI,KAAK0I,uBAAyB,WACxBD,EAAKb,yBACPa,EAAKH,2BACLnI,EAAE4E,SAEN,EACAiB,OAAOzD,iBAAiB,SAAUvC,KAAK0I,uBACzC,KAEAhB,EAAAA,EAAAA,QAAOC,IAAAA,UAAsB,YAAY,WAEvC3B,OAAOrD,oBAAoB,SAAU3C,KAAK0I,uBAC5C,KAEAhB,EAAAA,EAAAA,QAAOC,IAAAA,UAAsB,4BAA4B,SAAUS,GACjE,IAAMO,EAAgBrG,SAASa,cAAc,mBAC7C,GAAKwF,EAAL,CAEA,IAAMC,EAAaD,EAAcE,wBAGjC,GAFiB7C,OAAO8C,YAAc,IAIpC9I,KAAK6H,gBAAkB,CACrBvH,SAAU,QACVwH,IAAK,MACLC,KAAM,MACNgB,UAAW,wBACXC,MAAO,MACPC,SAAU,OACVC,OAAQ,OACRC,UAAW,YAER,CAEL,IAKMC,EAAeR,EAAWb,KAAQa,EAAWI,MAAQ,EAAMK,IAG3DC,EAAeC,KAAKC,IAAI,GAAIJ,GAG5BK,EAAkBF,KAAKG,IAXR,IAW0Bd,EAAWd,IAAM,IAC1D6B,EAAiBF,GAAmB,IAE1CzJ,KAAK6H,gBAAkB,CACrBvH,SAAU,QACVsJ,OAAS5D,OAAO6D,YAAcjB,EAAWd,IAAM,GAAM,KACrDC,KAAMuB,EAAe,KACrBN,MAAOK,QACPH,OAAQS,EAAiBG,QAAsB,OAC/CC,UAAYC,QACZb,UAAWM,EAAkB,KAEjC,CA1C0B,CA2C5B,KAEA/B,EAAAA,EAAAA,QAAOC,IAAAA,UAAsB,QAAQ,SAAUsC,GAAM,IAAAC,EAAA,KAmBnD,OAjBIlK,KAAK4H,wBACPqC,EAAKE,SAASlG,KACZ9D,EAAE,MAAO,CACPM,UAAW,gCACX2J,MAAOpK,KAAK6H,iBACX1H,EAAEoB,EAAe,CAClBsE,YAAa,SAACxF,GACZ6J,EAAKjK,MAAMoK,SAASC,OAAOC,eAAelK,EAC5C,EACA+C,QAAS,WACP8G,EAAKtC,wBAAyB,EAC9BzH,EAAE4E,QACJ,MAKCkF,CACT,GACF,IACC,I","sources":["webpack://@nodeloc/flarum-ext-my-emoji/webpack/bootstrap","webpack://@nodeloc/flarum-ext-my-emoji/webpack/runtime/compat get default export","webpack://@nodeloc/flarum-ext-my-emoji/webpack/runtime/define property getters","webpack://@nodeloc/flarum-ext-my-emoji/webpack/runtime/hasOwnProperty shorthand","webpack://@nodeloc/flarum-ext-my-emoji/webpack/runtime/make namespace object","webpack://@nodeloc/flarum-ext-my-emoji/./node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","webpack://@nodeloc/flarum-ext-my-emoji/./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","webpack://@nodeloc/flarum-ext-my-emoji/external root \"flarum.core.compat['common/extend']\"","webpack://@nodeloc/flarum-ext-my-emoji/external root \"flarum.core.compat['common/app']\"","webpack://@nodeloc/flarum-ext-my-emoji/external root \"flarum.core.compat['common/components/Button']\"","webpack://@nodeloc/flarum-ext-my-emoji/external root \"flarum.core.compat['common/components/Tooltip']\"","webpack://@nodeloc/flarum-ext-my-emoji/./src/forum/components/TextEditorButton.js","webpack://@nodeloc/flarum-ext-my-emoji/external root \"flarum.core.compat['common/components/TextEditor']\"","webpack://@nodeloc/flarum-ext-my-emoji/external root \"flarum.core.compat['common/Component']\"","webpack://@nodeloc/flarum-ext-my-emoji/external root \"flarum.core.compat['common/components/LoadingIndicator']\"","webpack://@nodeloc/flarum-ext-my-emoji/./src/forum/index.js","webpack://@nodeloc/flarum-ext-my-emoji/./src/common/utils/urlChecker.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export default function _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n  return _setPrototypeOf(o, p);\n}","import setPrototypeOf from \"./setPrototypeOf.js\";\nexport default function _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n  setPrototypeOf(subClass, superClass);\n}","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Button'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Tooltip'];","// TextEditorButton.js - 改进的按钮组件\nimport Button from 'flarum/common/components/Button';\nimport Tooltip from 'flarum/common/components/Tooltip';\n\n/**\n * 改进的TextEditorButton组件，添加了更好的工具提示和样式\n */\nexport default class TextEditorButton extends Button {\n  view(vnode) {\n    const originalView = super.view(vnode);\n\n    // 从属性中获取工具提示文本\n    const tooltipText = this.attrs.tooltipText || originalView.attrs.title;\n    delete originalView.attrs.title;\n\n    return (\n      <Tooltip text={tooltipText} position=\"top\" showOnFocus={false}>\n        {originalView}\n      </Tooltip>\n    );\n  }\n\n  static initAttrs(attrs) {\n    super.initAttrs(attrs);\n\n    attrs.className = `Button Button--icon Button--link Button-MyEmoji ${attrs.active ? 'active' : ''}`;\n    attrs.tooltipText = attrs.title;\n  }\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/TextEditor'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/Component'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/LoadingIndicator'];","import { extend } from 'flarum/common/extend';\nimport app from 'flarum/common/app';\nimport TextEditorButton from './components/TextEditorButton';\nimport TextEditor from 'flarum/common/components/TextEditor';\nimport urlChecker from '../common/utils/urlChecker';\nimport Component from 'flarum/common/Component';\nimport LoadingIndicator from 'flarum/common/components/LoadingIndicator';\n\n// 全局缓存，用于存储表情数据，避免多个编辑器实例重复加载\nconst globalEmojiCache = {\n  data: null,\n  categories: [],\n  loading: false,\n  lastLoadTime: 0,\n  // 缓存过期时间（20分钟）\n  expirationTime: 20 * 60 * 1000,\n\n  isValid() {\n    return this.data && Date.now() - this.lastLoadTime < this.expirationTime;\n  },\n\n  reset() {\n    this.data = null;\n    this.categories = [];\n    this.loading = false;\n    this.lastLoadTime = 0;\n  },\n\n  setData(data, categories) {\n    this.data = data;\n    this.categories = categories;\n    this.lastLoadTime = Date.now();\n    this.loading = false;\n  }\n};\n\n/**\n * MyEmoji Picker Component\n * 将表情选择器拆分为独立组件，方便管理\n */\nclass MyEmojiPicker extends Component {\n  oninit(vnode) {\n    super.oninit(vnode);\n\n    this.loading = !globalEmojiCache.isValid();\n    this.emojiData = globalEmojiCache.data || {};\n    this.categories = globalEmojiCache.categories || [];\n    this.currentCategory = this.categories.length > 0 ? this.categories[0].id : null;\n\n    // 滚动加载功能\n    this.itemsPerPage = 30;\n    this.currentPage = 1;\n    this.hasMoreItems = true;\n\n    // 如果缓存无效，加载数据\n    if (!globalEmojiCache.isValid() && !globalEmojiCache.loading) {\n      this.loadEmojiData();\n    }\n  }\n\n  oncreate(vnode) {\n    super.oncreate(vnode);\n\n    // 添加文档事件监听器，用于处理点击外部关闭\n    this.boundHandleOutsideClick = this.handleOutsideClick.bind(this);\n    document.addEventListener('mousedown', this.boundHandleOutsideClick);\n\n    // 添加键盘导航\n    this.boundHandleKeyDown = this.handleKeyDown.bind(this);\n    document.addEventListener('keydown', this.boundHandleKeyDown);\n  }\n\n  onremove(vnode) {\n    super.onremove(vnode);\n\n    // 清理事件监听器\n    document.removeEventListener('mousedown', this.boundHandleOutsideClick);\n    document.removeEventListener('keydown', this.boundHandleKeyDown);\n\n    // 清理Intersection Observer\n    if (this.intersectionObserver) {\n      this.intersectionObserver.disconnect();\n    }\n  }\n\n  handleOutsideClick(e) {\n    // 检查点击是否在选择器外部\n    if (this.element && !this.element.contains(e.target) &&\n        !document.querySelector('.Button-MyEmoji')?.contains(e.target)) {\n      this.attrs.onClose();\n    }\n  }\n\n  handleKeyDown(e) {\n    if (e.key === 'Escape') {\n      this.attrs.onClose();\n    }\n  }\n\n  loadEmojiData() {\n    // 设置全局加载状态\n    globalEmojiCache.loading = true;\n\n    app\n      .request({\n        method: 'GET',\n        url: app.forum.attribute('apiUrl') + '/nodeloc/myemoji',\n      })\n      .then((response) => {\n        const baseUrl = app.forum.attribute('baseUrl');\n        const customEmojis = [];\n\n        response['data'].forEach((customEmoji) => {\n          const path = customEmoji['attributes']['path'];\n\n          customEmojis.push({\n            id: customEmoji['id'],\n            name: customEmoji['attributes']['title'],\n            textToReplace: customEmoji['attributes']['text_to_replace'],\n            emoji: urlChecker(path) ? path : baseUrl + path,\n            category: customEmoji['attributes']['category'],\n            category_name: customEmoji['attributes']['category_name'],\n            // 添加懒加载标志\n            loaded: false\n          });\n        });\n\n        // 按分类分组表情\n        const emojiData = customEmojis.reduce((result, emoji) => {\n          (result[emoji.category] = result[emoji.category] || []).push(emoji);\n          return result;\n        }, {});\n\n        // 提取分类\n        const categories = Object.keys(emojiData).map(categoryId => {\n          return {\n            id: categoryId,\n            name: emojiData[categoryId][0].category_name\n          };\n        });\n\n        // 更新全局缓存\n        globalEmojiCache.setData(emojiData, categories);\n\n        // 更新组件状态\n        this.emojiData = emojiData;\n        this.categories = categories;\n        this.loading = false;\n\n        // 设置默认分类\n        if (categories.length > 0) {\n          this.selectCategory(categories[0].id);\n        }\n\n        m.redraw();\n      })\n      .catch(error => {\n        console.error('Error loading emoji data:', error);\n        this.loading = false;\n        globalEmojiCache.loading = false;\n        m.redraw();\n      });\n  }\n\n  selectCategory(categoryId) {\n    this.currentCategory = categoryId;\n    this.currentPage = 1;\n    this.hasMoreItems = true;\n\n    // 重置滚动位置\n    if (this.emojiListElement) {\n      this.emojiListElement.scrollTop = 0;\n    }\n\n    m.redraw();\n  }\n\n  getCurrentEmojis() {\n    if (!this.currentCategory) return [];\n    if (!this.emojiData[this.currentCategory]) return [];\n\n    return this.emojiData[this.currentCategory].slice(0, this.currentPage * this.itemsPerPage);\n  }\n\n  handleScroll(e) {\n    const el = e.target;\n\n    // 检查是否滚动到底部\n    if (el.scrollHeight - el.scrollTop - el.clientHeight < 50) {\n      this.loadMoreItems();\n    }\n  }\n\n  loadMoreItems() {\n    if (!this.hasMoreItems || !this.currentCategory || !this.emojiData[this.currentCategory]) return;\n\n    const totalItems = this.emojiData[this.currentCategory].length;\n\n    if (this.currentPage * this.itemsPerPage < totalItems) {\n      this.currentPage++;\n      m.redraw();\n    } else {\n      this.hasMoreItems = false;\n    }\n  }\n\n  handleEmojiSelect(emoji) {\n    // 将表情插入编辑器\n    this.attrs.insertEmoji(emoji.textToReplace);\n\n    // 关闭选择器\n    this.attrs.onClose();\n  }\n\n  setupIntersectionObserver() {\n    if (!('IntersectionObserver' in window)) return;\n\n    this.intersectionObserver = new IntersectionObserver(\n      (entries, observer) => {\n        entries.forEach(entry => {\n          if (entry.isIntersecting) {\n            const emojiId = entry.target.dataset.emojiId;\n            const categoryId = entry.target.dataset.categoryId;\n\n            // 标记表情已加载\n            if (this.emojiData[categoryId]) {\n              const emoji = this.emojiData[categoryId].find(e => e.id === emojiId);\n              if (emoji) {\n                emoji.loaded = true;\n                m.redraw();\n              }\n            }\n\n            // 取消观察此元素\n            observer.unobserve(entry.target);\n          }\n        });\n      },\n      {\n        root: this.emojiListElement,\n        rootMargin: '100px',\n        threshold: 0.1\n      }\n    );\n  }\n\n  view() {\n    return m('div', {\n      className: 'MyEmoji-picker',\n      onclick: (e) => e.stopPropagation()\n    }, [\n      // 分类标签栏\n      m('div', { className: 'MyEmoji-tab-bar' },\n        this.categories.map(category =>\n          m('button', {\n            className: this.currentCategory === category.id ? 'active' : '',\n            onclick: () => this.selectCategory(category.id)\n          }, category.name)\n        )\n      ),\n\n      // 表情显示区域\n      m('div', {\n        className: 'emoji-picker',\n        oncreate: (vnode) => {\n          this.emojiListElement = vnode.dom;\n          this.setupIntersectionObserver();\n        },\n        onscroll: (e) => this.handleScroll(e)\n      },\n        this.loading ?\n          m('div', { className: 'MyEmoji-loading' }, m(LoadingIndicator)) :\n          m('div', { className: 'MyEmoji-grid' }, [\n            // 表情列表\n            ...this.getCurrentEmojis().map(emoji =>\n              m('span', {\n                className: 'MyEmoji',\n                onclick: () => this.handleEmojiSelect(emoji),\n                title: emoji.name\n              },\n                emoji.loaded ?\n                  m('img', { src: emoji.emoji, alt: emoji.name }) :\n                  m('div', {\n                    className: 'emoji-lazyload',\n                    'data-emoji-id': emoji.id,\n                    'data-category-id': emoji.category,\n                    oncreate: (vnode) => {\n                      if (this.intersectionObserver) {\n                        this.intersectionObserver.observe(vnode.dom);\n                      } else {\n                        emoji.loaded = true;\n                      }\n                    }\n                  }, m(LoadingIndicator, { size: 'small' }))\n              )\n            ),\n\n            // 加载更多指示器\n            this.hasMoreItems && this.getCurrentEmojis().length > 0 ?\n              m('div', { className: 'MyEmoji-load-more' }, m(LoadingIndicator, { size: 'small' })) :\n              null\n          ])\n      )\n    ]);\n  }\n}\n\napp.initializers.add(\n  'nodeloc-flarum-ext-my-emoji',\n  () => {\n    extend(TextEditor.prototype, 'oninit', function () {\n      this.isMyEmojiPickerVisible = false;\n      this.myEmojiPosition = { top: 0, left: 0 };\n    });\n\n    extend(TextEditor.prototype, 'toolbarItems', function (items) {\n      items.remove('emoji'); // 移除默认的emoji按钮\n      items.add(\n        'MyEmoji',\n        TextEditorButton.component({\n          onclick: (event) => {\n            event.preventDefault();\n\n            // 切换选择器可见性\n            this.isMyEmojiPickerVisible = !this.isMyEmojiPickerVisible;\n\n            if (this.isMyEmojiPickerVisible) {\n              this.calculateMyEmojiPosition(event);\n            }\n\n            m.redraw();\n          },\n          icon: 'far fa-smile-wink',\n          title: app.translator.trans('nodeloc-emoji.forum.composer.emoji_tooltip'),\n        })\n      );\n    });\n\n    extend(TextEditor.prototype, 'oncreate', function () {\n      // 处理窗口大小变化时重新定位\n      this.boundRepositionMyEmoji = () => {\n        if (this.isMyEmojiPickerVisible) {\n          this.calculateMyEmojiPosition();\n          m.redraw();\n        }\n      };\n      window.addEventListener('resize', this.boundRepositionMyEmoji);\n    });\n\n    extend(TextEditor.prototype, 'onremove', function () {\n      // 清理事件监听器\n      window.removeEventListener('resize', this.boundRepositionMyEmoji);\n    });\n\n    extend(TextEditor.prototype, 'calculateMyEmojiPosition', function (event) {\n      const MyEmojiButton = document.querySelector('.Button-MyEmoji');\n      if (!MyEmojiButton) return;\n\n      const buttonRect = MyEmojiButton.getBoundingClientRect();\n      const isMobile = window.innerWidth <= 768;\n\n      if (isMobile) {\n        // 移动端定位：屏幕居中\n        this.myEmojiPosition = {\n          position: 'fixed',\n          top: '50%',\n          left: '50%',\n          transform: 'translate(-50%, -50%)',\n          width: '90%',\n          maxWidth: '90vw',\n          height: 'auto',\n          maxHeight: '80vh'\n        };\n      } else {\n        // 桌面端定位：固定高度，确保标签栏高度不会变小\n        const pickerHeight = 320; // 选择器高度\n        const pickerWidth = 520;  // 选择器宽度\n        const minTabHeight = 40;  // 标签栏最小高度\n\n        // 计算选择器左侧位置，使其与按钮居中对齐\n        const leftPosition = buttonRect.left + (buttonRect.width / 2) - (pickerWidth / 2);\n\n        // 确保不会超出屏幕左侧\n        const adjustedLeft = Math.max(10, leftPosition);\n\n        // 确保选择器不会超出屏幕顶部\n        const availableHeight = Math.min(pickerHeight, buttonRect.top - 10);\n        const useFixedHeight = availableHeight >= 200; // 只有当有足够空间时才使用固定高度\n\n        this.myEmojiPosition = {\n          position: 'fixed',\n          bottom: (window.innerHeight - buttonRect.top + 10) + 'px',\n          left: adjustedLeft + 'px',\n          width: pickerWidth + 'px',\n          height: useFixedHeight ? pickerHeight + 'px' : 'auto', // 使用固定高度\n          minHeight: (minTabHeight + 100) + 'px', // 确保标签栏加内容区域有最小高度\n          maxHeight: availableHeight + 'px',\n        };\n      }\n    });\n\n    extend(TextEditor.prototype, 'view', function (vdom) {\n      // 如果可见，将表情选择器附加到视图\n      if (this.isMyEmojiPickerVisible) {\n        vdom.children.push(\n          m('div', {\n            className: 'ComposerBody-MyEmojiContainer',\n            style: this.myEmojiPosition\n          }, m(MyEmojiPicker, {\n            insertEmoji: (text) => {\n              this.attrs.composer.editor.insertAtCursor(text);\n            },\n            onClose: () => {\n              this.isMyEmojiPickerVisible = false;\n              m.redraw();\n            }\n          }))\n        );\n      }\n\n      return vdom;\n    });\n  },\n  -150 // 优先级：在 flarum/emoji 之前初始化\n);\n","// urlChecker.js - URL检查工具（如果需要修改）\nexport default function urlChecker(url) {\n  if (!url) return false;\n\n  // 检查URL是否为绝对URL（以http://或https://开头）\n  return /^(https?:)?\\/\\//i.test(url);\n}\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","Symbol","toStringTag","value","_setPrototypeOf","p","setPrototypeOf","bind","__proto__","_inheritsLoose","subClass","superClass","create","constructor","flarum","core","compat","TextEditorButton","_Button","apply","arguments","view","vnode","originalView","tooltipText","this","attrs","title","m","Tooltip","text","position","showOnFocus","initAttrs","className","active","Button","globalEmojiCache","data","categories","loading","lastLoadTime","expirationTime","isValid","Date","now","reset","setData","MyEmojiPicker","_Component","_proto","oninit","emojiData","currentCategory","length","id","itemsPerPage","currentPage","hasMoreItems","loadEmojiData","oncreate","boundHandleOutsideClick","handleOutsideClick","document","addEventListener","boundHandleKeyDown","handleKeyDown","onremove","removeEventListener","intersectionObserver","disconnect","e","_document$querySelect","element","contains","target","querySelector","onClose","_this","app","method","url","attribute","then","response","baseUrl","customEmojis","forEach","customEmoji","path","push","name","textToReplace","emoji","test","category","category_name","loaded","reduce","result","keys","map","categoryId","selectCategory","redraw","error","console","emojiListElement","scrollTop","getCurrentEmojis","slice","handleScroll","el","scrollHeight","clientHeight","loadMoreItems","totalItems","handleEmojiSelect","insertEmoji","setupIntersectionObserver","_this2","window","IntersectionObserver","entries","observer","entry","isIntersecting","emojiId","dataset","find","unobserve","root","rootMargin","threshold","_this3","onclick","stopPropagation","dom","onscroll","LoadingIndicator","concat","src","alt","observe","size","Component","add","extend","TextEditor","isMyEmojiPickerVisible","myEmojiPosition","top","left","items","_this4","remove","component","event","preventDefault","calculateMyEmojiPosition","icon","trans","_this5","boundRepositionMyEmoji","MyEmojiButton","buttonRect","getBoundingClientRect","innerWidth","transform","width","maxWidth","height","maxHeight","leftPosition","pickerWidth","adjustedLeft","Math","max","availableHeight","min","useFixedHeight","bottom","innerHeight","pickerHeight","minHeight","minTabHeight","vdom","_this6","children","style","composer","editor","insertAtCursor"],"sourceRoot":""}